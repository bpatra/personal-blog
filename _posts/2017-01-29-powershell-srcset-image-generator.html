---
layout: post
status: publish
published: true
title: Powershell srcset image generator
author:
  display_name: Benoit Patra
  login: benoitpatra
  email: benoit.patra@gmail.com
  url: https://www.benoitpatra.com
author_login: benoitpatra
author_email: benoit.patra@gmail.com
author_url: https://www.benoitpatra.com
wordpress_id: 1988
wordpress_url: http://benoitpatra.com/?p=1988
date: '2017-01-29 18:33:27 +0000'
date_gmt: '2017-01-29 18:33:27 +0000'
categories:
- Programming
- Scripting
tags:
- html
- HTML5
- powershell
- pictures
- web
- SEO
comments: []
---
<p>If you have a website and SEO matters for you, then you probably had to <a href="https://developers.google.com/speed/docs/insights/OptimizeImages">optimize images</a>. To this aim, you may want to have responsive images. As explained <a href="https://www.sitepoint.com/how-to-build-responsive-images-with-srcset/">here</a>,</p>
<blockquote><p>a responsive image is an image which is displayed in its best form on a web page, depending on the device your website is being viewed from.</p></blockquote>
<p>One of the modern way to serve quickly responsive images is to benefit from the <code>srcset</code> html attribute. Shortly, depending on parameters and your viewport (i.e. browser window) the <code>srcset</code> attribute will tell the browser to download the best appropriate image for the current display.</p>
<p>For example, if you put the following HTML element</p>
<p>[code language="html"]<br />
<img src="images/fcnantes-champions-95.jpg"<br />
srcset="images/fcnantes-champions-95.jpg 200w, images/fcnantes-champions-95-400.jpg 400w,<br />
images/fcnantes-champions-95-600.jpg 600w,<br />
images/fcnantes-champions-95-800.jpg 800w"><br />
[/code]</p>
<p>Your server logic can serve up to four different images representing the same pictures.</p>
<p>You may guess that creating all this different resized pictures can be painful manually. In this blog post we propose the following Powershell script to help you for the automation of this task.</p>
<p>[code language="powershell"]<br />
Param ( [Parameter(Mandatory=$True)] [ValidateNotNull()] $imageSource, [Parameter(Mandatory=$true)][ValidateNotNull()] $quality )</p>
<p>if (!(Test-Path $imageSource)){throw( "Cannot find the source image")}<br />
if ($quality -lt 0 -or $quality -gt 100){throw( "quality must be between 0 and 100.")}</p>
<p>[void][System.Reflection.Assembly]::LoadWithPartialName("System.Drawing")<br />
$resolvedPath = Join-Path $PWD -ChildPath $imageSource<br />
$bmp = [System.Drawing.Image]::FromFile($resolvedPath)</p>
<p>#hardcoded canvas size...<br />
$canvasWidths = @(200, 400, 600, 800)</p>
<p>foreach($canvasWidth in $canvasWidths){<br />
    #Encoder parameter for image quality<br />
    $myEncoder = [System.Drawing.Imaging.Encoder]::Quality<br />
    $encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)<br />
    $encoderParams.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter($myEncoder, $quality)<br />
    # get codec<br />
    $myImageCodecInfo = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders()|where {$_.MimeType -eq 'image/jpeg'}</p>
<p>    #compute the final ratio to use<br />
    $ratioX = $canvasWidth / $bmp.Width;<br />
    $ratioY = $canvasWidth / $bmp.Height;<br />
    $ratio = $ratioY<br />
    if($ratioX -le $ratioY){<br />
        $ratio = $ratioX<br />
    }</p>
<p>    #create resized bitmap<br />
    $newWidth = [int] ($bmp.Width*$ratio)<br />
    $newHeight = [int] ($bmp.Height*$ratio)<br />
    $bmpResized = New-Object System.Drawing.Bitmap($newWidth, $newHeight)<br />
    $graph = [System.Drawing.Graphics]::FromImage($bmpResized)</p>
<p>    $graph.Clear([System.Drawing.Color]::White)<br />
    $graph.DrawImage($bmp,0,0 , $newWidth, $newHeight)</p>
<p>    $targetFileName = [System.IO.Path]::GetFileNameWithoutExtension($imageSource) + "-" + $canvasWidth + ".jpg"<br />
    $dir = [System.IO.Path]::GetDirectoryName($resolvedPath)<br />
    $targetFilePath = Join-Path $dir -ChildPath $targetFileName<br />
    Write-Host "Saving file" $targetFilePath<br />
    #save to file<br />
    $bmpResized.Save($targetFilePath,$myImageCodecInfo, $($encoderParams))<br />
    $graph.Dispose()<br />
    $bmpResized.Dispose()<br />
}<br />
$bmp.Dispose()<br />
[/code]</p>
<p>Now you can simply invoke the script like this: <code>.\SrcsetBuilder.ps1 "..\images\MyImage.jpg" 85</code>. Then all generated images: <em>MyImage-200.jpg, MyImage-400.jpg, MyImage-600.jpg, MyImage-800.jpg</em> are located next to <em>MyImage.jpg</em>.<br />
You can modify the generated images widths by changing the values in the array <code>$canvasWidths</code> (line 11).</p>
