---
layout: post
status: publish
published: true
title: TeamCity on Windows Azure VM part 2/2 - enabling SSL with reverse proxy
author:
  display_name: Benoit Patra
  login: benoitpatra
  email: benoit.patra@gmail.com
  url: https://www.benoitpatra.com
author_login: benoitpatra
author_email: benoit.patra@gmail.com
author_url: https://www.benoitpatra.com
wordpress_id: 939
wordpress_url: http://benoitpatra.com/?p=939
date: '2015-10-07 23:17:32 +0000'
date_gmt: '2015-10-07 21:17:32 +0000'
categories:
- Programming
- Continuous Integration
tags:
- azure
- iis
- internet information service
- sql azure
- ssl
- teamcity
- web sockets
comments:
- id: 16281
  author: Chris Wood
  author_email: chris.wood+comments@redbear.co.uk
  author_url: ''
  date: '2016-05-12 14:34:41 +0000'
  date_gmt: '2016-05-12 14:34:41 +0000'
  content: "Thanks for the great tutorial!\r\n\r\nA few additional notes having just
    gone through this myself:\r\n\r\n* in the new Azure portal, you'll need to to
    your public IP address's entry in \"All Resources\" and then go to \"Properties\".
    This will allow you to set an external DNS name for your Virtual Machine.\r\n\r\n*
    also in the new Azure portal, you open up ports 80 and 443 by configuring the
    Inbound Security Rules for the Network Group your VM uses. It's only the destination
    port range that you need to set to 80 (leave the source as *).\r\n\r\n* finally,
    in addition to URL Rewrite 2.0, I also had to install Application Request Routing
    via the Web Platform Installer. Without this, IIS won't act as a reverse proxy
    and the rules you've added won't work. Rather than choosing \"blank rule\", I
    actually chose the \"Reverse Proxy\" option instead and this prompted me to configure
    ARR and switch certain things on.\r\n\r\nHope this helps someone!"
- id: 16312
  author: benoitpatra
  author_email: benoit.patra@gmail.com
  author_url: http://www.benoitpatra.com
  date: '2016-05-13 08:27:01 +0000'
  date_gmt: '2016-05-13 08:27:01 +0000'
  content: |-
    Thank you very much Chris!
    I am sure your comments will help others.
- id: 18940
  author: Willem
  author_email: wsleroux@gmail.com
  author_url: ''
  date: '2016-10-20 00:14:18 +0000'
  date_gmt: '2016-10-20 00:14:18 +0000'
  content: Thanks Benoit for a good post and thanks Chris - I also had to install
    Application Request Routing.
- id: 19727
  author: Vlad
  author_email: vlad2890@gmail.com
  author_url: ''
  date: '2016-12-05 12:07:13 +0000'
  date_gmt: '2016-12-05 12:07:13 +0000'
  content: "Hi Chris, \r\n\r\nCould you maybe share with us how does your \"Reverse
    Proxy \" rules looks like ?  \r\n\r\nI know it`s some months for this post but
    it seems that this is the only relevant TC-IIS reverse proxy documentation out
    there."
---
<p>In the <a href="/2015/09/21/setup-teamcity-on-windows-azure-vm-part-1-on-2/">previous post</a> we explained how to install a TeamCity server on a Windows Azure Virtual Machine. We used an external SQL Azure database for the internal database used by Teamcity. The first post ended with a functional TeamCity web app that could not be visible from outside. The objective of this second post is to show how to secure the web app by serving up the pages with SSL. Similarly as the previous post I will detailed out all the procedure from scratch so this tutorial will be accessible to an IIS beginner. Indeed, we are going to use a reverse proxy technique on IIS (Internet Information Service, the Microsoft web server).&nbsp; I would like to thank my friend Gabriel Boya&nbsp;who suggested me the reverse proxy trick. Let us remark that it could also be a good solution for serving under SSL any other non IIS website running on windows.</p>
<p>If you have followed the steps of the previous post, then you should have a TeamCity server that is served on port 8080. You should be able to view&nbsp;it with the IE browser under the remote desktop VM at <em>localhost:8080</em>. Let us start this post by answering the following question:</p>
<h3>What is a reverse proxy and why use it?</h3>
<p>If you try to enable SSL with Tomcat server who serves TeamCity, you are going to suffer for not a very good result. See for instance <a href="http://paulstovell.com/blog/teamcity-ssl-on-windows-with-redirect-from-http">this tutorial</a>&nbsp;and all the questions it brought. Even if you manage to import your certificate on the java certificate store, you will have problem with WebSockets...</p>
<p>So I suggest you to implement a reverse proxy. The name sounds complicated but it is very basic concept: this is simply another website that will act as an intermediate for communicating to your first and primary website (in our case the Tomcat server). Here, we are going to create an empty IIS website, visible from outside on port 80 and 443. It will redirect the incoming request to our TeamCity server which is listening on port 8080.</p>
<p>[caption id="attachment_964" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/reverseproxy1-e1450465605159.png"><img class="wp-image-964 size-large" src="/assets/images/legacy-wp-content/2015/10/reverseproxy1-1024x265.png" alt="Representation of the reverse proxy for our situation" width="625" height="162" /></a> Representation of the reverse proxy for our situation[/caption]</p>
<h3>Install IIS and the required components</h3>
<p>First we will have to install and setup IIS with the following features on our Windows server 2012. It is a very easy thing to do. Search the ServerManager in windows &nbsp;then, choose to&nbsp;configure this Local Server (this Virtual Machine) &nbsp;with a Role-based installation.</p>
<p>[caption id="attachment_943" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/servermanager-e1450467917676.jpg"><img class="wp-image-943 size-large" src="/assets/images/legacy-wp-content/2015/10/servermanager-1024x561.jpg" alt="servermanager" width="625" height="342" /></a> Add roles and features[/caption]</p>
<p>Then, check the "Web Server (IIS)" as a role to install.</p>
<p>[caption id="attachment_944" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/servermanager1-e1450467943285.jpg"><img class="wp-image-944 size-large" src="/assets/images/legacy-wp-content/2015/10/servermanager1-1024x552.jpg" alt="servermanager1" width="625" height="337" /></a> Install IIS[/caption]</p>
<p>Keep the default feaures.</p>
<p>[caption id="attachment_945" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/servermanager2-e1450467962897.jpg"><img class="wp-image-945 size-large" src="/assets/images/legacy-wp-content/2015/10/servermanager2-1024x574.jpg" alt="servermanager2" width="625" height="350" /></a> Keep default installation features[/caption]</p>
<p>In this recent version, TeamCity uses the <a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a>. To make them work, our reverse proxy server will need them: check WebSocket Protocol.</p>
<p>[caption id="attachment_946" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/servermanager3-e1450467982814.jpg"><img class="wp-image-946 size-large" src="/assets/images/legacy-wp-content/2015/10/servermanager3-1024x549.jpg" alt="servermanager3" width="625" height="335" /></a> Check the WebSocket Protocol[/caption]</p>
<p>Check that everything is right there... and press Install.</p>
<p>[caption id="attachment_947" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/servermanager4-e1450468005735.jpg"><img class="wp-image-947 size-large" src="/assets/images/legacy-wp-content/2015/10/servermanager4-1024x560.jpg" alt="servermanager4" width="625" height="342" /></a> Check that everything is prepared for installation[/caption]</p>
<p>Now that we have installed IIS with our required features (WebSocket),it is&nbsp;accessible from the menu. I suggest you pin that to the easy launch if you do not want to search it each time you will need it.</p>
<p>[caption id="attachment_948" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/iis-e1450468024716.jpg"><img class="wp-image-948 size-large" src="/assets/images/legacy-wp-content/2015/10/iis-1024x274.jpg" alt="iis" width="625" height="167" /></a> IIS well installed[/caption]</p>
<h3>Install URL rewrite module</h3>
<p>The most simple way to set up the reverse proxy is to have the IIS URL rewrite module installed. Any Microsoft web modules should be installed using the Microsoft Web platform Installer. If you do not have it yet, install it from&nbsp;<a href="http://www.iis.net/learn/install/web-platform-installer/web-platform-installer-direct-downloads">there</a>.</p>
<p>Then, in the Web Platform Installer look for the URL Rewrite 2.0 and install it.</p>
<p>[caption id="attachment_950" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/urlrewrite-e1450468044166.jpg"><img class="wp-image-950 size-large" src="/assets/images/legacy-wp-content/2015/10/urlrewrite-1024x596.jpg" alt="urlrewrite" width="625" height="364" /></a> URL Rewrite 2.0 installation with Web Platform Installer[/caption]</p>
<h3>The Reverse proxy website</h3>
<p>Ok now we are going to create our proxy website. IIS has gently created a website and its <a href="http://stackoverflow.com/questions/3868612/what-is-an-iis-application-pool">associated pool</a>. Delete them both without any mercy and create a new one (called TeamcityFrom) with the following parameters. Remark: that there is no website and nothing under the <em>C:inetpubwwwroot</em> this is just the default IIS website directory.</p>
<p>[caption id="attachment_951" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/teamcityfront-e1450468065511.jpg"><img class="wp-image-951 size-large" src="/assets/images/legacy-wp-content/2015/10/teamcityfront-1024x614.jpg" alt="TeamcityFront" width="625" height="375" /></a> New TeamCityFront IIS website that point to the inetpub/wwwroot folder[/caption]</p>
<h3>Create the rewrite rule</h3>
<p>We are going to create a rule that basically transform all incoming http request to request targeting locally <em>localhost:8080.&nbsp;</em>Open the URL rewrite menu that should be visible in the window when you click on your site and create a blank rule with the following parameters.</p>
<p>[caption id="attachment_952" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/inboundrule1.jpg"><img class="wp-image-952 size-large" src="/assets/images/legacy-wp-content/2015/10/inboundrule1-1024x621.jpg" alt="inboundRule1" width="625" height="379" /></a> URL Rewrite for our TeamcityFront website[/caption]</p>
<p>[caption id="attachment_953" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/inboundrule2-e1450468113336.jpg"><img class="wp-image-953 size-large" src="/assets/images/legacy-wp-content/2015/10/inboundrule2-1024x616.jpg" alt="inboundRule2" width="625" height="376" /></a> second part of the rewrite rule[/caption]</p>
<p>Now let us go back to the management Azure portal and add two new endpoints http for port 80 and https for 443 in Windows Azure</p>
<p>[caption id="attachment_954" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/endpoints3-e1450468424284.jpg"><img class="wp-image-954 size-full" src="/assets/images/legacy-wp-content/2015/10/endpoints3-e1450468424284.jpg" alt="endpoints3" width="625" height="394" /></a> Add HTTP on port 80 and HTTPS on port 443 with the Azure Management Portal for our VM[/caption]</p>
<p>Now check that you are able to browse your site at testteamcity.cloudapp.net from the outside. But you could object what was the point? Indeed, we could have setup TeamCity on port 80 and add the HTTP endpoint on Azure and the result would be the same. Yes you would be right, but remember, our goal is to serve securely with&nbsp;SSL!</p>
<h3>Enabling SSL</h3>
<p>[caption id="attachment_955" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/personalpfx-e1450468449460.jpg"><img class="wp-image-955 size-full" src="/assets/images/legacy-wp-content/2015/10/personalpfx-e1450468449460.jpg" alt="PersonalPfx" width="625" height="484" /></a> Certificate installation[/caption]</p>
<p>To enable SSL you need to have a certificate, you can buy one at <a href="https://www.gandi.net/">Gandi.net</a> for example. When you get the .pfx file install it on your VM by double clicking and put the certificate on the personal store.</p>
<p>An SSL certificate is bound to a domain and you do not own cloudapp.net so you cannot use the subdomain&nbsp;te<em>stteamcity.cloudapp.net</em> of your VM. You will have to create an alias for example <em>build.keluro.com</em> and create a CNAME that will redirect to the VM.</p>
<p>Here is the procedure if you manage your domains in Office365.</p>
<p>[caption id="attachment_956" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/office365-e1450468470239.jpg"><img class="wp-image-956 size-large" src="/assets/images/legacy-wp-content/2015/10/office365-1024x515.jpg" alt="office365" width="625" height="314" /></a> Creating a CNAME subdomain in Office365 that point to the *.cloudapp.net address of your VM[/caption]</p>
<p>Now in IIS, click on your site and edit SSL bindings, add this newly created &nbsp;subdomain <em>build.keluro.com </em>and use the SSL certificate that should be recognized automatically by IIS.</p>
<p>[caption id="attachment_957" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/sslbindings-e1450468186516.jpg"><img class="wp-image-957 size-large" src="/assets/images/legacy-wp-content/2015/10/sslbindings-1024x599.jpg" alt="SSLBindings" width="625" height="366" /></a> Create an HTTPS binding for the proxy server under IIS[/caption]</p>
<p>At this stage, you should be able to browse your site on https from the outside with a clean green lock sign.</p>
<p>[caption id="attachment_971" align="alignleft" width="600"]<a href="/assets/images/legacy-wp-content/2015/10/workshttps-e1450468225594.jpg"><img class="wp-image-971 size-full" src="/assets/images/legacy-wp-content/2015/10/workshttps-e1450468225594.jpg" alt="Browsing in security with https" width="600" height="410" /></a> Browsing in security with https[/caption]</p>
<h3>Redirection Http to Https</h3>
<p>You do not want your user to continue accessing insecurely your web app with basic Http. So a <del>good</del> mandatory practice is to redirect your http traffic to a secure https endpoint. Once again, we will benefit from the reverse proxy on IIS. Simply create a new URL rewrite rule.</p>
<p>[caption id="attachment_959" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/redirecturlrewrite-e1450468255387.jpg"><img class="wp-image-959 size-large" src="/assets/images/legacy-wp-content/2015/10/redirecturlrewrite-899x1024.jpg" alt="redirecturlrewrite" width="625" height="712" /></a> An HTTP to HTTPS redirect rewrite rule[/caption]</p>
<p>Then place you HTTPS redirection rule before the ReverseProxy rule.</p>
<p>[caption id="attachment_960" align="aligncenter" width="625"]<a href="/assets/images/legacy-wp-content/2015/10/urlrewrite2-e1450468294921.jpg"><img class="wp-image-960 size-large" src="/assets/images/legacy-wp-content/2015/10/urlrewrite2-1024x437.jpg" alt="urlrewrite2" width="625" height="267" /></a> Place the HTTPS redirection rule before the ReverseProxy rewrite rule[/caption]</p>
<p>Then know when you type <em>http://build.keluro.com</em> or simply <em>build.keluro.com</em> you'll be automatically redirected and the job is done!</p>
<p>[caption id="attachment_961" align="aligncenter" width="660"]<a href="/assets/images/legacy-wp-content/2015/10/browsinghttp-e1444251752576.jpg"><img class="wp-image-961 size-full" src="/assets/images/legacy-wp-content/2015/10/browsinghttp-e1444251752576.jpg" alt="browsinghttp" width="660" height="358" /></a> A working website that redirects automatically to https[/caption]</p>
